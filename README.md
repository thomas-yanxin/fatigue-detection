è€è§„çŸ©ï¼Œå…ˆä¸Š
[Bç«™è§†é¢‘](https://www.bilibili.com/video/BV16B4y1F7eR/)

# èƒŒæ™¯ä»‹ç»

## èƒŒæ™¯ä¸€ï¼ˆè€å¸ˆçš„ç¦éŸ³ï¼‰

&emsp;&emsp;è®²å°ä¸Šè€å¸ˆè®¤çœŸä¸Šè¯¾ï¼Œå£è‹¥æ‚¬æ²³ï¼›è®²å°ä¸‹åŒå­¦é¢‘é¢‘ç‚¹å¤´ï¼ŒåŒç›®å…·é—­ï¼  

&emsp;&emsp;45åˆ†é’Ÿæ˜¯å¾ˆç´§å¼ çš„ï¼Œè€å¸ˆåœ¨è¿™ä¸ªæ—¶é—´æ®µå†…éœ€è¦æŠŠè®¡åˆ’çš„æ•™å­¦ä»»åŠ¡å®Œæˆï¼Œè€Œå¦‚æœå­¦ç”Ÿæ— æ³•ç§¯æé…åˆã€è®¤çœŸå¬è®²ï¼Œè¿˜åœ¨â€œé—­ç›®å…»ç¥â€ã€ç•™ç€å£æ°´ï¼Œè€å¸ˆè¿˜éœ€è¦åœ¨è¯¾å ‚ä¸Šå«é†’é‚£äº›â€œå·²ç»ç¡ç€äº†çš„äººâ€ï¼Œå…¶å®è¯¾å ‚æ•ˆç‡å°±å¤§å¤§é™ä½äº†ã€‚  

&emsp;&emsp;è€Œå¦‚æœæ­¤æ—¶èƒ½å¤Ÿé€šè¿‡å®¤å†…æ‘„åƒå¤´æ•æ‰å­¦ç”Ÿé¢éƒ¨è¡¨æƒ…åŠåŠ¨ä½œï¼Œä»¥æ­¤æ¥è¯†åˆ«å­¦ç”Ÿæ˜¯å¦åœ¨æ‰“çŒç¡ï¼Œå¹¶å‘åŒå­¦åŠè€å¸ˆç§¯æåé¦ˆï¼Œæˆ–è®¸èƒ½å¤Ÿå¤§å¤§æé«˜è¯¾å ‚æ•ˆç‡ï¼Œä¹Ÿæ–¹ä¾¿è€å¸ˆåŠæ—¶äº†è§£å­¦ç”Ÿè¯¾å ‚æƒ…å†µã€‚

![](https://ai-studio-static-online.cdn.bcebos.com/cad92ba716f44149a2e5373fd0c6ac10a4884f8f16044426a48d491a2ab7ddec)

## èƒŒæ™¯äºŒï¼ˆäº¤é€šå‡ºè¡Œï¼‰
&emsp;&emsp;ä¸€ä¸ªäººå¼€è½¦æ˜¯ä¸€ä»¶å¾ˆç´¯çš„äº‹ï¼Œå°¤å…¶æ˜¯å¼€é•¿é€”ï¼Œåˆ°äº†è¡Œè½¦åæœŸï¼Œäººä¼šéå¸¸ç–²æƒ«ï¼Œä¼šå‡ºç°â€œé—­ç›®â€ã€â€œæ‰“å“ˆæ¬ â€ç­‰åŠ¨ä½œã€‚è€Œæ­¤æ—¶ï¼Œç”±äºäººçš„ååº”èƒ½åŠ›å—é˜»ï¼Œå¾ˆå®¹æ˜“å‘ç”Ÿäº¤é€šäº‹æ•…ã€‚  
&emsp;&emsp;æ­¤æ—¶è‹¥æœ‰ä¸€ä¸ªæ£€æµ‹è®¾å¤‡ï¼Œç›‘æµ‹é©¾é©¶å‘˜çš„é¢éƒ¨è¡¨æƒ…ï¼Œåœ¨å…¶ç–²æƒ«æ—¶åŠæ—¶æé†’é©¾é©¶å‘˜æ³¨æ„ä¼‘æ¯ï¼Œèƒ½å¤Ÿæœ‰æ•ˆé¿å…å› ç–²åŠ³é©¾é©¶è€Œå¯¼è‡´çš„è½¦ç¥¸å‘ç”Ÿã€‚  
![](https://ai-studio-static-online.cdn.bcebos.com/72feb8edeee84b34956f5c0a628019ee69325d67f4964f989f83a196d12ba748)


&emsp;&emsp;è€Œâ€œçœ¼ç›â€çš„çé—­å’Œâ€œå˜´â€çš„å¼ é—­æ˜¯æ£€æµ‹äººæ˜¯å¦ç–²åŠ³çš„ä¸€ç§åˆç†æ–¹æ¡ˆã€‚   

![](https://ai-studio-static-online.cdn.bcebos.com/06c48f2c163e49989210a11149409e92f4a9bcab02d7456b9d225a651b4205f4)


# æŠ€æœ¯æ–¹æ¡ˆ
&emsp;&emsp;æœ¬é¡¹ç›®åŸºäºPaddleDetectionç›®æ ‡æ£€æµ‹å¼€å‘å¥—ä»¶ï¼Œé€‰å–1.3Mè¶…è½»é‡PPYOLO tinyè¿›è¡Œé¡¹ç›®å¼€å‘ï¼Œå¹¶éƒ¨ç½²äºwindowsç«¯ã€‚
### PPYOLO tinyæ˜¯ä»€ä¹ˆï¼Ÿ
&emsp;&emsp;åœ¨å½“å‰ç§»åŠ¨äº’è”ç½‘ã€ç‰©è”ç½‘ã€è½¦è”ç½‘ç­‰è¡Œä¸šè¿…çŒ›å‘å±•çš„èƒŒæ™¯ä¸‹ï¼Œè¾¹ç¼˜è®¾å¤‡ä¸Šç›´æ¥éƒ¨ç½²ç›®æ ‡æ£€æµ‹çš„éœ€æ±‚è¶Šæ¥è¶Šæ—ºç››ã€‚ç”Ÿäº§çº¿ä¸Šå¾€å¾€éœ€è¦åœ¨æä½ç¡¬ä»¶æˆæœ¬çš„ç¡¬ä»¶ä¾‹å¦‚æ ‘è“æ´¾ã€FPGAã€K210 ç­‰èŠ¯ç‰‡ä¸Šéƒ¨ç½²ç›®æ ‡æ£€æµ‹ç®—æ³•ã€‚è€Œæˆ‘ä»¬å¸¸ç”¨çš„æ‰‹æœº Appï¼Œä¹Ÿå¾ˆéš¾ç›´æ¥åœ¨ç»ˆç«¯é‡‡ç”¨è¶…è¿‡ 6M çš„æ·±åº¦å­¦ä¹ ç®—æ³•ã€‚å¦‚ä½•åœ¨å°½é‡ä¸æŸå¤±ç²¾åº¦çš„å‰æä¸‹ï¼Œè·å¾—ä½“ç§¯æ›´å°ã€è¿ç®—é€Ÿåº¦æ›´å¿«çš„ç®—æ³•å‘¢ï¼Ÿå¾—ç›Šäº PaddleSlim é£æ¡¨æ¨¡å‹å‹ç¼©å·¥å…·çš„èƒ½åŠ›ï¼Œä½“ç§¯ä»…ä¸º 1.3M çš„ PP-YOLO Tiny è¯ç”Ÿäº†ï¼!  

**ç²¾åº¦é€Ÿåº¦æ•°æ®**
![](https://ai-studio-static-online.cdn.bcebos.com/efb9eb24b1fb4b09a8236b0946b4c0f8b28a1120d1d745a991497409fdeef0d7)

&emsp;&emsp;é‚£ PP-YOLO Tiny å…·ä½“é‡‡ç”¨äº†å“ªäº›ä¼˜åŒ–ç­–ç•¥å‘¢ï¼Ÿ

&emsp;&emsp;é¦–å…ˆï¼ŒPP-YOLO Tiny æ²¿ç”¨äº† PP-YOLO ç³»åˆ—æ¨¡å‹çš„ sppï¼Œiou loss, drop block, mixup, sync bn ç­‰ä¼˜åŒ–æ–¹æ³•ï¼Œå¹¶è¿›ä¸€æ­¥é‡‡ç”¨äº†è¿‘ 10 ç§é’ˆå¯¹ç§»åŠ¨ç«¯çš„ä¼˜åŒ–ç­–ç•¥ï¼š

&emsp;&emsp;1ã€æ›´é€‚ç”¨äºç§»åŠ¨ç«¯çš„éª¨å¹²ç½‘ç»œï¼š

&emsp;&emsp;&emsp;&emsp;éª¨å¹²ç½‘ç»œå¯ä»¥è¯´æ˜¯ä¸€ä¸ªæ¨¡å‹çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œå¯¹ç½‘ç»œçš„æ€§èƒ½ã€ä½“ç§¯å½±å“å·¨å¤§ã€‚PP-YOLO Tiny é‡‡ç”¨äº†ç§»åŠ¨ç«¯é«˜æ€§ä»·æ¯”éª¨å¹²ç½‘ç»œ MobileNetV3ã€‚

&emsp;&emsp;2ã€æ›´é€‚ç”¨ç§»åŠ¨ç«¯çš„æ£€æµ‹å¤´ï¼ˆheadï¼‰ï¼š

&emsp;&emsp;&emsp;&emsp;é™¤äº†éª¨å¹²ç½‘ç»œï¼ŒPP-YOLO Tiny çš„æ£€æµ‹å¤´ï¼ˆheadï¼‰éƒ¨åˆ†é‡‡ç”¨äº†æ›´é€‚ç”¨äºç§»åŠ¨ç«¯çš„æ·±åº¦å¯åˆ†ç¦»å·ç§¯ï¼ˆDepthwise Separable Convolutionï¼‰ï¼Œç›¸æ¯”å¸¸è§„çš„å·ç§¯æ“ä½œï¼Œæœ‰æ›´å°‘çš„å‚æ•°é‡å’Œè¿ç®—æˆæœ¬, æ›´é€‚ç”¨äºç§»åŠ¨ç«¯çš„å†…å­˜ç©ºé—´å’Œç®—åŠ›ã€‚

&emsp;&emsp;3ã€å»é™¤å¯¹æ¨¡å‹ä½“ç§¯ã€é€Ÿåº¦æœ‰æ˜¾è‘—å½±å“çš„ä¼˜åŒ–ç­–ç•¥ï¼š

&emsp;&emsp;&emsp;&emsp;åœ¨ PP-YOLO ä¸­ï¼Œé‡‡ç”¨äº†è¿‘ 10 ç§ä¼˜åŒ–ç­–ç•¥ï¼Œä½†å¹¶ä¸æ˜¯æ¯ä¸€ç§éƒ½é€‚ç”¨äºç§»åŠ¨ç«¯è½»é‡åŒ–ç½‘ç»œï¼Œæ¯”å¦‚ iou aware å’Œ matrix nms ç­‰ã€‚è¿™ç±» Trick åœ¨æœåŠ¡å™¨ç«¯å®¹æ˜“è®¡ç®—ï¼Œä½†åœ¨ç§»åŠ¨ç«¯ä¼šå¼•å…¥å¾ˆå¤šé¢å¤–çš„æ—¶å»¶ï¼Œå¯¹ç§»åŠ¨ç«¯æ¥è¯´æ€§ä»·æ¯”ä¸é«˜ï¼Œå› æ­¤å»æ‰åè€Œæ›´é€‚å½“ã€‚

&emsp;&emsp;4ã€ä½¿ç”¨æ›´å°çš„è¾“å…¥å°ºå¯¸

&emsp;&emsp;&emsp;&emsp;ä¸ºäº†åœ¨ç§»åŠ¨ç«¯æœ‰ï¤å¥½çš„æ€§èƒ½ï¼ŒPP-YOLO Tiny é‡‡ç”¨ 320 å’Œ 416 è¿™ä¸¤ç§ï¤å°çš„è¾“å…¥å›¾åƒå°ºå¯¸ã€‚å¹¶åœ¨ PaddleDetection2.0 ä¸­æä¾› tools/anchor_cluster.py è„šæœ¬ï¼Œä½¿ç”¨æˆ·å¯ä»¥ä¸€é”®å¼çš„è·å¾—ä¸ç›®æ ‡æ•°æ®é›†åŒ¹é…çš„ Anchorã€‚ä¾‹å¦‚ï¼Œåœ¨ COCO æ•°æ®é›†ä¸Šï¼Œæˆ‘ä»¬ä½¿ç”¨ 320*320 å°ºåº¦é‡æ–°èšç±»ï¦º anchorï¼Œå¹¶å¯¹åº”çš„åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æŠŠæ¯ batch å›¾â½šçš„ç¼©æ”¾èŒƒå›´è°ƒæ•´åˆ° 192-512 æ¥é€‚é…â¼©å°ºâ¼¨è¾“â¼Šå›¾ç‰‡çš„è®­ç»ƒï¼Œå¾—åˆ°æ›´é«˜æ€§èƒ½ã€‚

&emsp;&emsp;5ã€å¬å›ç‡ä¼˜åŒ–

&emsp;&emsp;&emsp;&emsp;åœ¨ä½¿â½¤â¼©å°ºå¯¸è¾“å…¥å›¾ç‰‡æ—¶ï¼Œå¯¹åº”çš„ç›®æ ‡å°ºå¯¸ä¹Ÿä¼šè¢«ç¼©â¼©ï¼Œæ¼æ£€çš„æ¦‚ç‡ä¼šå˜å¤§ï¼Œå¯¹åº”çš„æˆ‘ä»¬é‡‡ç”¨äº†å¦‚ä¸‹ä¸¤ç§æ–¹æ³•æ¥æå‡ç›®æ ‡çš„å¬å›ç‡ï¼š

&emsp;&emsp;&emsp;&emsp;a.åŸçœŸå®æ¡†çš„æ³¨å†Œæ–¹æ³•æ˜¯æ³¨å†Œåˆ°ç½‘æ ¼â¾¥æœ€åŒ¹é…çš„ anchor ä¸Šï¼Œä¼˜åŒ–åè¿˜ä¼šåŒæ—¶æ³¨å†Œåˆ°æ‰€æœ‰ä¸è¯¥çœŸå®æ¡†çš„ IoU ï¥§å°äº 0.25 çš„ anchor ä¸Šï¼Œæâ¾¼ï¦ºçœŸå®æ¡†æ³¨å†Œçš„æ­£ï¦µã€‚  

&emsp;&emsp;&emsp;&emsp;b.åŸæ¥æ‰€æœ‰ä¸çœŸå®æ¡† IoU å°äº 0.7 çš„ anchor ä¼šè¢«å½“é”™è´Ÿä¾‹ï¼Œä¼˜åŒ–åå°†è¯¥é˜ˆå€¼å‡å°åˆ° 0.5ï¼Œé™ä½ï¦ºè´Ÿï¦µæ¯”ï¦µã€‚  


&emsp;&emsp;&emsp;&emsp;é€šè¿‡ä»¥ä¸Šå¢åŠ æ­£ï¦µã€å‡å°‘è´Ÿï¦µçš„æ–¹æ³•ï¼Œå¼¥è¡¥ï¦ºåœ¨å°å°ºå¯¸ä¸Šçš„æ­£è´Ÿï¦µå€¾æ–œé—®é¢˜ï¼Œæé«˜ï¦ºå¬å›ç‡ã€‚

&emsp;&emsp;6ã€æ›´å¤§çš„ batch size

&emsp;&emsp;&emsp;&emsp;å¾€å¾€æ›´å¤§çš„ Batch Size å¯ä»¥ä½¿è®­ç»ƒæ›´åŠ ç¨³å®šï¼Œè·å–æ›´ä¼˜çš„ç»“æœã€‚åœ¨ PP-YOLO Tiny çš„è®­ç»ƒä¸­ï¼Œå•å¡ batch size ç”± 24 æå‡åˆ°äº† 32ï¼Œ8 å¡æ€» batch size=8*32=256ï¼Œæœ€ç»ˆå¾—åˆ°åœ¨ COCO æ•°æ®é›†ä¸Šä½“ç§¯ 4.3Mï¼Œç²¾åº¦ä¸é¢„æµ‹é€Ÿåº¦éƒ½è¾ƒä¸ºç†æƒ³çš„æ¨¡å‹ã€‚

&emsp;&emsp;7ã€é‡åŒ–åå‹ç¼©

&emsp;&emsp;&emsp;&emsp;æœ€åï¼Œç»“åˆ Paddle Inference å’Œ Paddle Lite é¢„æµ‹åº“æ”¯æŒçš„åé‡åŒ–ç­–ç•¥ï¼Œå³åœ¨å°†æƒé‡ä¿å­˜æˆï¥¾åŒ–åçš„ int8 æ•°æ®ã€‚è¿™æ ·çš„æ“ä½œï¼Œæ˜¯æ¨¡å‹ä½“ç§¯ç›´æ¥å‹ç¼©åˆ°äº† 1.3Mï¼Œè€Œé¢„æµ‹æ—¶ä½¿ç”¨ Paddle Lite åŠ è½½æƒé‡ï¼Œä¼šå°† int8 æ•°æ®è¿˜åŸå› float32 æƒé‡ï¼Œæ‰€ä»¥å¯¹ç²¾åº¦å’Œé¢„æµ‹é€Ÿåº¦â¼ä¹æ²¡æœ‰ä»»ä½•å½±å“ã€‚

&emsp;&emsp;é€šè¿‡ä»¥ä¸Šä¸€ç³»åˆ—ä¼˜åŒ–ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº† 1.3M è¶…è¶…è¶…è½»é‡çš„ PP-YOLO tiny æ¨¡å‹ï¼Œè€Œç®—æ³•å¯ä»¥é€šè¿‡ Paddle Lite ç›´æ¥éƒ¨ç½²åœ¨éº’éºŸ 990 ç­‰è½»é‡åŒ–èŠ¯ç‰‡ä¸Šï¼Œé¢„æµ‹æ•ˆæœä¹Ÿéå¸¸ç†æƒ³ã€‚


# å®åœ°æ“ä½œ


```python
# å…ˆå°†PaddleDetectionä»giteeä¸Šdownloadä¸‹æ¥
!git clone https://gitee.com/paddlepaddle/PaddleDetection.git
```

### æ•°æ®å¤„ç†
1. è§£å‹æ•°æ®é›†ï¼›
2. å¯¹æ•°æ®è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†ï¼Œå°†å…¶è½¬åŒ–ä¸ºCOCOæ ¼å¼ä»¥ç¬¦åˆPaddleDetectionä¸­æ‰€æ”¯æŒçš„æ•°æ®é›†æ ¼å¼ã€‚


```python
# æ•°æ®é›†è§£å‹
!unzip -oq /home/aistudio/data/data85880/fdd-dataset.zip
```


```python
# è¿™é‡Œä¿®æ”¹åŸæ•°æ®é›†ä¸­æ ‡æ³¨æ–‡ä»¶é‡Œ<path>å…ƒç´ ä¸­çš„å†…å®¹
import xml.dom.minidom
import os

path = r'dataset/Annotations'  # xmlæ–‡ä»¶å­˜æ”¾è·¯å¾„
sv_path = r'dataset/Annotations1'  # ä¿®æ”¹åçš„xmlæ–‡ä»¶å­˜æ”¾è·¯å¾„
files = os.listdir(path)
cnt = 1

for xmlFile in files:
    dom = xml.dom.minidom.parse(os.path.join(path, xmlFile))  # æ‰“å¼€xmlæ–‡ä»¶ï¼Œé€åˆ°domè§£æ
    root = dom.documentElement  # å¾—åˆ°æ–‡æ¡£å…ƒç´ å¯¹è±¡
    item = root.getElementsByTagName('path')  # è·å–pathè¿™ä¸€nodeåå­—åŠç›¸å…³å±æ€§å€¼
    for i in item:
        i.firstChild.data = 'dataset/JPEGImages/' + str(cnt).zfill(6) + '.jpg'  # xmlæ–‡ä»¶å¯¹åº”çš„å›¾ç‰‡è·¯å¾„

    with open(os.path.join(sv_path, xmlFile), 'w') as fh:
        dom.writexml(fh)
    cnt += 1

```


```python
# ç„¶åå¯¹æ•°æ®é›†è¿›è¡Œæ ‡å‡†åŒ–æ ¼å¼æ“ä½œ
%cd dataset/
!rm -ir Annotations
!mv Annotations1 Annotations
%cd ..
```

    rm: descend into directory 'dataset/Annotations'? ^C
    mv: cannot stat 'dataset/Annotations1': No such file or directory


&emsp;&emsp;ç”±äºåŸæ•°æ®é›†ä¸­å­˜åœ¨å›¾ç‰‡æ•°æ®ä¸æ ‡æ³¨æ•°æ®ä¸åŒ¹é…çš„é—®é¢˜ï¼Œæ•…éœ€è¦å°†ä¸åŒ¹é…çš„è¿™éƒ¨åˆ†æ•°æ®åˆ é™¤ã€‚


```python
import os,shutil

jpeg = 'dataset/JPEGImages'
jpeg_list = os.listdir(jpeg)

anno = 'dataset/Annotations'
anno_list = os.listdir(anno)

for pic in jpeg_list:
    name = pic.split('.')[0]
    anno_name = name + '.xml'
    print(anno_name)
    if anno_name not in anno_list:
        os.remove(os.path.join(jpeg,pic))
```


```python
è¿™é‡Œæˆ‘ä»¬é€šè¿‡paddlexä¸­çš„æ•°æ®é›†åˆ’åˆ†å·¥å…·å¸®åŠ©æˆ‘ä»¬è¿›è¡Œæ•°æ®é›†åˆ’åˆ†ã€‚
```


```python
!pip install paddlex
!pip install paddle2onnx
```


```python
æˆ‘ä»¬è®¾ç½®äº†è®­ç»ƒé›†ã€éªŒè¯é›†ã€æµ‹è¯•é›†æ¯”ä¾‹ä¸º8ï¼š1ï¼š1ï¼Œè®­ç»ƒé›†å…±2332ä¸ªsammples,éªŒè¯é›†å’Œæµ‹è¯•é›†å‡ä¸º291ä¸ªsamplesã€‚
```


```python
!paddlex --split_dataset --format VOC --dataset_dir dataset --val_value 0.1 --test_value 0.1
```

    /opt/conda/envs/python35-paddle120-env/lib/python3.7/site-packages/setuptools/depends.py:2: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
      import imp
    Dataset Split Done.[0m
    [0mTrain samples: 2332[0m
    [0mEval samples: 291[0m
    [0mTest samples: 291[0m
    [0mSplit files saved in dataset[0m
    [0m[0m


```python
PaddleDetectionä¸­æä¾›äº†VOCæ•°æ®é›†è½¬COCOæ•°æ®é›†çš„è„šæœ¬ï¼Œä½†æä¾›çš„è„šæœ¬å­˜åœ¨ä¸€äº›bug,æœ¬äººåœ¨PaddleDetectionçš„Github issueä¸­æ‰¾åˆ°äº†ä¸€ä¸ªä¿®å¤åçš„è„šæœ¬ï¼šx2coco.pyã€‚  
è¿™é‡Œæˆ‘ä»¬å°†å‰é¢ä¿®æ”¹å®Œæ¯•çš„VOCæ ¼å¼çš„æ•°æ®é›†è½¬åŒ–ä¸ºç¬¦åˆPaddleDetection PPYOLO tinyçš„COCOæ•°æ®é›†æ ¼å¼ã€‚
```


```python
!python x2coco.py --dataset_type voc --voc_anno_dir /home/aistudio/dataset/Annotations/ --voc_anno_list /home/aistudio/dataset/ImageSets/Main/train.txt --voc_label_list /home/aistudio/dataset/labels.txt --voc_out_name voc_test.json
!python x2coco.py --dataset_type voc --voc_anno_dir /home/aistudio/dataset/Annotations/ --voc_anno_list /home/aistudio/dataset/ImageSets/Main/val.txt --voc_label_list /home/aistudio/dataset/labels.txt --voc_out_name voc_val.json
!python x2coco.py --dataset_type voc --voc_anno_dir /home/aistudio/dataset/Annotations/ --voc_anno_list /home/aistudio/dataset/ImageSets/Main/test.txt --voc_label_list /home/aistudio/dataset/labels.txt --voc_out_name voc_train.json
!mv voc_train.json dataset/
!mv voc_test.json dataset/
!mv voc_val.json dataset/
```

    Start converting !
    100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1631/1631 [00:00<00:00, 12327.36it/s]
    Start converting !
    100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 583/583 [00:00<00:00, 12504.37it/s]
    Start converting !
    100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1283/1283 [00:00<00:00, 12609.82it/s]


### ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆ./PaddleDetection/configs/ppyolo/ppyolo_tiny_650e_coco.ymlï¼‰


åœ¨yoloç³»åˆ—æ¨¡å‹ä¸­ï¼Œå¯ä»¥è¿è¡Œtools/anchor_cluster.pyæ¥å¾—åˆ°é€‚ç”¨äºä½ çš„æ•°æ®é›†Anchorï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š


```python
!python tools/anchor_cluster.py -c configs/ppyolo/ppyolo_tiny_650e_coco.yml -n 9 -s 608 -m v2 -i 1000
```

ä¸ºäº†é€‚é…åœ¨è‡ªå®šä¹‰æ•°æ®é›†ä¸Šè®­ç»ƒï¼Œéœ€è¦å¯¹å‚æ•°é…ç½®åšä¸€äº›ä¿®æ”¹ï¼š

æ•°æ®è·¯å¾„é…ç½®: åœ¨yamlé…ç½®æ–‡ä»¶ä¸­ï¼Œä¾æ®æ•°æ®å‡†å¤‡ä¸­å‡†å¤‡å¥½çš„è·¯å¾„ï¼Œé…ç½®TrainReaderã€EvalReaderå’ŒTestReaderçš„è·¯å¾„ã€‚  
![](https://ai-studio-static-online.cdn.bcebos.com/e6fdda98a6ac4150b91d1d6f6a242d8a8e667c159d0345ea8b1a283ff0103ed7)  
å…¶ä½™å‚æ•°å…·ä½“å¯å‚ç…§[PaddleDetection](https://github.com/PaddlePaddle/PaddleDetection),è¿™é‡Œä¸ä½œè¿‡å¤šä»‹ç»ã€‚

ç„¶åæ‰§è¡Œè®­ç»ƒè„šæœ¬å³å¯ã€‚


```python
%cd PaddleDetection/
!pip install -r requirements.txt
!python -u tools/train.py -c configs/ppyolo/ppyolo_tiny_650e_coco.yml \
              -o pretrain_weights=https://paddledet.bj.bcebos.com/models/pretrained/MobileNetV3_large_x0_5_pretrained.pdparams \
              --eval \
              -r output/ppyolo_tiny_650e_coco/1200 \
              --vdl_log_dir vdl_log_dir/scalar
```

### æ•°æ®å¯¼å‡º
&emsp;&emsp;è®­ç»ƒå®Œåæˆ‘ä»¬å°†è®­ç»ƒè¿‡ç¨‹ä¸­ä¿å­˜çš„æ¨¡å‹å¯¼å‡ºä¸ºinferenceæ ¼å¼æ¨¡å‹ï¼Œå…¶åŸå› åœ¨äºï¼šPaddlePaddleæ¡†æ¶ä¿å­˜çš„æƒé‡æ–‡ä»¶åˆ†ä¸ºä¸¤ç§ï¼šæ”¯æŒå‰å‘æ¨ç†å’Œåå‘æ¢¯åº¦çš„è®­ç»ƒæ¨¡å‹ å’Œ åªæ”¯æŒå‰å‘æ¨ç†çš„æ¨ç†æ¨¡å‹ã€‚äºŒè€…çš„åŒºåˆ«æ˜¯æ¨ç†æ¨¡å‹é’ˆå¯¹æ¨ç†é€Ÿåº¦å’Œæ˜¾å­˜åšäº†ä¼˜åŒ–ï¼Œè£å‰ªäº†ä¸€äº›åªåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ‰éœ€è¦çš„tensorï¼Œé™ä½æ˜¾å­˜å ç”¨ï¼Œå¹¶è¿›è¡Œäº†ä¸€äº›ç±»ä¼¼å±‚èåˆï¼Œkernelé€‰æ‹©çš„é€Ÿåº¦ä¼˜åŒ–ã€‚è€Œå¯¼å‡ºçš„inferenceæ ¼å¼æ¨¡å‹åŒ…æ‹¬__model__ã€__params__å’Œmodel.ymlä¸‰ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«è¡¨ç¤ºæ¨¡å‹çš„ç½‘ç»œç»“æ„ã€æ¨¡å‹æƒé‡å’Œæ¨¡å‹çš„é…ç½®æ–‡ä»¶ï¼ˆåŒ…æ‹¬æ•°æ®é¢„å¤„ç†å‚æ•°ç­‰ï¼‰ã€‚


```python
# å¯¼å‡ºæ¨¡å‹ï¼Œé»˜è®¤å­˜å‚¨äºoutput/ppyoloç›®å½•
!python tools/export_model.py -c configs/ppyolo/ppyolo_tiny_650e_coco.yml -o weights=Poutput/ppyolo_tiny_650e_coco/best_model
```

åŒæ ·çš„ï¼ŒPaddleDetectionä¹Ÿæä¾›äº†åŸºäºPythonçš„é¢„æµ‹è„šæœ¬ä¾›å¼€å‘è€…ä½¿ç”¨ã€‚
å‚æ•°è¯´æ˜å¦‚ä¸‹:

| å‚æ•° | æ˜¯å¦å¿…é¡»|å«ä¹‰ |
|-------|-------|----------|
| --model_dir | Yes|ä¸Šè¿°å¯¼å‡ºçš„æ¨¡å‹è·¯å¾„ |
| --image_file | Option |éœ€è¦é¢„æµ‹çš„å›¾ç‰‡ |
| --image_dir  | Option |  è¦é¢„æµ‹çš„å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„   |
| --video_file | Option |éœ€è¦é¢„æµ‹çš„è§†é¢‘ |
| --camera_id | Option | ç”¨æ¥é¢„æµ‹çš„æ‘„åƒå¤´IDï¼Œé»˜è®¤ä¸º-1(è¡¨ç¤ºä¸ä½¿ç”¨æ‘„åƒå¤´é¢„æµ‹ï¼Œå¯è®¾ç½®ä¸ºï¼š0 - (æ‘„åƒå¤´æ•°ç›®-1) )ï¼Œé¢„æµ‹è¿‡ç¨‹ä¸­åœ¨å¯è§†åŒ–ç•Œé¢æŒ‰`q`é€€å‡ºè¾“å‡ºé¢„æµ‹ç»“æœåˆ°ï¼šoutput/output.mp4|
| --use_gpu | No |æ˜¯å¦GPUï¼Œé»˜è®¤ä¸ºFalse|
| --run_mode | No |ä½¿ç”¨GPUæ—¶ï¼Œé»˜è®¤ä¸ºfluid, å¯é€‰ï¼ˆfluid/trt_fp32/trt_fp16/trt_int8ï¼‰|
| --batch_size | No |é¢„æµ‹æ—¶çš„batch sizeï¼Œåœ¨æŒ‡å®š`image_dir`æ—¶æœ‰æ•ˆ |
| --threshold | No|é¢„æµ‹å¾—åˆ†çš„é˜ˆå€¼ï¼Œé»˜è®¤ä¸º0.5|
| --output_dir | No|å¯è§†åŒ–ç»“æœä¿å­˜çš„æ ¹ç›®å½•ï¼Œé»˜è®¤ä¸ºoutput/|
| --run_benchmark | No| æ˜¯å¦è¿è¡Œbenchmarkï¼ŒåŒæ—¶éœ€æŒ‡å®š`--image_file`æˆ–`--image_dir` |
| --enable_mkldnn | No | CPUé¢„æµ‹ä¸­æ˜¯å¦å¼€å¯MKLDNNåŠ é€Ÿ |
| --cpu_threads | No| è®¾ç½®cpuçº¿ç¨‹æ•°ï¼Œé»˜è®¤ä¸º1 |


```python
!python deploy/python/infer.py --model_dir=/path/to/models --image_file=/path/to/image --use_gpu=(False/True)
```

å½“ç„¶ï¼Œåœ¨æœ¬é¡¹ç›®ä¸­ä¹Ÿæä¾›äº†PaddleX è®­ç»ƒåŠå¯¼å‡ºæ–¹å¼ï¼Œå¯ä¾›è¯»è€…æœ‹å‹å°è¯•ä¸åŒçš„é£æ¡¨å¥—ä»¶ã€‚


```python
# ç¯å¢ƒå˜é‡é…ç½®ï¼Œç”¨äºæ§åˆ¶æ˜¯å¦ä½¿ç”¨GPU
# è¯´æ˜æ–‡æ¡£ï¼šhttps://paddlex.readthedocs.io/zh_CN/develop/appendix/parameters.html#gpu
import os
os.environ['CUDA_VISIBLE_DEVICES'] = '0'

from paddlex.det import transforms
import paddlex as pdx

# å®šä¹‰è®­ç»ƒå’ŒéªŒè¯æ—¶çš„transforms
# APIè¯´æ˜ https://paddlex.readthedocs.io/zh_CN/develop/apis/transforms/det_transforms.html
train_transforms = transforms.Compose([
    transforms.MixupImage(mixup_epoch=250), transforms.RandomDistort(),
    transforms.RandomExpand(), transforms.RandomCrop(), transforms.Resize(
        target_size=608, interp='RANDOM'), transforms.RandomHorizontalFlip(),
    transforms.Normalize()
])

eval_transforms = transforms.Compose([
    transforms.Resize(
        target_size=608, interp='CUBIC'), transforms.Normalize()
])

# å®šä¹‰è®­ç»ƒå’ŒéªŒè¯æ‰€ç”¨çš„æ•°æ®é›†
# APIè¯´æ˜ï¼šhttps://paddlex.readthedocs.io/zh_CN/develop/apis/datasets.html#paddlex-datasets-vocdetection
train_dataset = pdx.datasets.VOCDetection(
    data_dir='dataset',
    file_list='dataset/train_list.txt',
    label_list='dataset/labels.txt',
    transforms=train_transforms,
    shuffle=True)
eval_dataset = pdx.datasets.VOCDetection(
    data_dir='dataset',
    file_list='dataset/val_list.txt',
    label_list='dataset/labels.txt',
    transforms=eval_transforms)

# åˆå§‹åŒ–æ¨¡å‹ï¼Œå¹¶è¿›è¡Œè®­ç»ƒ
# å¯ä½¿ç”¨VisualDLæŸ¥çœ‹è®­ç»ƒæŒ‡æ ‡ï¼Œå‚è€ƒhttps://paddlex.readthedocs.io/zh_CN/develop/train/visualdl.html
num_classes = len(train_dataset.labels)

# APIè¯´æ˜: https://paddlex.readthedocs.io/zh_CN/develop/apis/models/detection.html#paddlex-det-ppyolo
model = pdx.det.PPYOLO(num_classes=num_classes)

# APIè¯´æ˜: https://paddlex.readthedocs.io/zh_CN/develop/apis/models/detection.html#train
# å„å‚æ•°ä»‹ç»ä¸è°ƒæ•´è¯´æ˜ï¼šhttps://paddlex.readthedocs.io/zh_CN/develop/appendix/parameters.html
model.train(
    num_epochs=270,
    train_dataset=train_dataset,
    train_batch_size=8,
    eval_dataset=eval_dataset,
    learning_rate=0.000125,
    lr_decay_epochs=[210, 240],
    save_dir='output/ppyolo',
    save_interval_epochs=1,
    use_vdl=True)
```


```python
!paddlex --export_inference --model_dir=output/ppyolo/best_model --save_dir=./inference_model
```

è¯·ç‚¹å‡»[æ­¤å¤„](https://ai.baidu.com/docs#/AIStudio_Project_Notebook/a38e5576)æŸ¥çœ‹æœ¬ç¯å¢ƒåŸºæœ¬ç”¨æ³•.  <br>
Please click [here ](https://ai.baidu.com/docs#/AIStudio_Project_Notebook/a38e5576) for more detailed instructions. 
